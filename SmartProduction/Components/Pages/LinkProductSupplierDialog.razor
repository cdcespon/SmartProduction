@using SmartProduction.Models
@using SmartProduction.Services
@inject ProductService ProductService
@inject SupplierService SupplierService
@inject DialogService DialogService

<RadzenTemplateForm TItem="SupplierProduct" Data="@sp" Submit="@OnSubmit">
    <RadzenStack Gap="1rem" class="rz-p-4">
        <RadzenRow AlignItems="AlignItems.Center">
            <RadzenColumn Size="4"><RadzenLabel Text="Producto" /></RadzenColumn>
            <RadzenColumn Size="8">
                <RadzenDropDown style="width: 100%;" TValue="int" Data="@availableProducts" TextProperty="Name" ValueProperty="Id" 
                    @bind-Value="sp.ProductId" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" FilterOperator="StringFilterOperator.Contains" AllowFiltering="true" />
            </RadzenColumn>
        </RadzenRow>

        <RadzenRow AlignItems="AlignItems.Center">
            <RadzenColumn Size="4"><RadzenLabel Text="Cod. Proveedor" /></RadzenColumn>
            <RadzenColumn Size="8">
                <RadzenTextBox style="width: 100%;" @bind-Value="sp.SupplierSKU" />
            </RadzenColumn>
        </RadzenRow>

        <RadzenRow AlignItems="AlignItems.Center">
            <RadzenColumn Size="4"><RadzenLabel Text="Precio Compra" /></RadzenColumn>
            <RadzenColumn Size="8">
                <RadzenNumeric style="width: 100%;" TValue="decimal" @bind-Value="sp.PurchasePrice" />
            </RadzenColumn>
        </RadzenRow>

        <RadzenRow AlignItems="AlignItems.Center">
            <RadzenColumn Size="4"><RadzenLabel Text="DÃ­as Entrega" /></RadzenColumn>
            <RadzenColumn Size="8">
                <RadzenNumeric style="width: 100%;" TValue="int" @bind-Value="sp.LeadTimeDays" Min="0" />
            </RadzenColumn>
        </RadzenRow>

        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.5rem">
            <RadzenButton ButtonType="ButtonType.Submit" Text="Vincular" Icon="add_business" />
            <RadzenButton Click="@((args) => DialogService.Close(false))" Variant="Variant.Flat" ButtonStyle="ButtonStyle.Light" Text="Cancelar" />
        </RadzenStack>
    </RadzenStack>
</RadzenTemplateForm>

@code {
    [Parameter] public int SupplierId { get; set; }
    
    SupplierProduct sp = new();
    IEnumerable<Product>? availableProducts;

    protected override async Task OnInitializedAsync()
    {
        sp.SupplierId = SupplierId;
        availableProducts = await ProductService.GetProductsAsync();
    }

    async Task OnSubmit()
    {
        await SupplierService.AddProductLinkAsync(sp);
        DialogService.Close(true);
    }
}
